name: Update conformance test reports

on:
  repository_dispatch:
    types: [update-conformance-test-reports]
  workflow_dispatch: # for testing this workflow

permissions: write-all

jobs:
  update:
    name: Update conformance test reports
    runs-on: ubuntu-latest
    steps:
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
      - name: Check out the reference checker
        uses: actions/checkout@v3
        with:
          ref: update-conformance-test-reports
          fetch-depth: 0
          path: reference-checker
      - name: Merge latest changes
        run: git rebase origin/main
        working-directory: reference-checker
      - name: Check out conformance test input files
        uses: actions/checkout@v3
        with:
          repository: jspecify/jspecify
          ref: main
          path: jspecify
      - name: Run conformance tests
        uses: gradle/gradle-build-action@v2
        with:
          arguments: conformanceTest conformanceTestOnSamples
          build-root-directory: reference-checker
        env:
          JSPECIFY_CONFORMANCE_TEST_MODE: write
      - name: Create or Update PR
        run: |
          if [[ -n $(git status --porcelain tests/ConformanceTest*-report.txt) ]]; then
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "Update conformance test reports." tests/ConformanceTest*-report.txt
            git push
            if gh pr list --head "${branch}" --state open | egrep -q 'no pull requests'; then
              gh pr create --base main --title "Update conformance test reports."  --body ""
            fi
          else
            echo "No conformance test updates found."
          fi
        working-directory: reference-checker
        shell: bash --noprofile --norc -e -o pipefail -x {0}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
